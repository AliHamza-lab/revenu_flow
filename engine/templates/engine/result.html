{% extends 'engine/base.html' %}

{% block content %}
<style>
    .tabs {
        display: flex;
        gap: 2rem;
        border-bottom: 1px solid var(--border);
        margin-bottom: 2rem;
    }

    .tab-btn {
        padding: 0.75rem 0.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-weight: 500;
        color: var(--text-muted);
        transition: all 0.2s;
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
    }
</style>

<div class="header animate-fade">
    <div>
        <a href="{% url 'dashboard' %}"
            style="text-decoration: none; color: var(--primary); font-weight: 600; font-size: 0.875rem;">‚Üê Back to
            Dashboard</a>
        <h1 style="margin-top: 1rem;">Audit Report: {{ session.file_name }}</h1>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{% url 'download_cleaned' session.id %}" class="btn btn-primary">Download Cleaned Data</a>
        <button class="btn btn-outline" onclick="window.print()">Export Report</button>
    </div>
</div>

<div class="tabs animate-fade">
    <div class="tab-btn active" onclick="switchTab('summary')">Executive Summary</div>
    <div class="tab-btn" onclick="switchTab('details')">Quality Details</div>
    <div class="tab-btn" onclick="switchTab('analytics')">Advanced Analytics</div>
    <div class="tab-btn" onclick="switchTab('preview')">Data Preview</div>
</div>

<!-- Executive Summary Tab -->
<div id="summary" class="tab-content active animate-fade">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <div class="card" style="text-align: center; padding: 3rem 2rem;">
            <h3>Integrity Index</h3>
            <div style="position: relative; width: 160px; height: 160px; margin: 2rem auto;">
                <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                        stroke="#e2e8f0" stroke-width="3" />
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                        stroke="var(--primary)" stroke-width="3" stroke-dasharray="{{ session.health_score }}, 100" />
                </svg>
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 800; font-family: 'Outfit';">
                    {{ session.health_score|floatformat:0 }}%
                </div>
            </div>
            <p
                style="font-weight: 600; color: {% if session.health_score > 80 %}var(--success){% elif session.health_score > 50 %}var(--warning){% else %}var(--danger){% endif %};">
                {% if session.health_score > 80 %}Enterprise Ready{% elif session.health_score > 50 %}Manual Review
                Suggested{% else %}Critical Integrity Failure{% endif %}
            </p>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div class="card">
                <h3>Quality Dimensions</h3>
                <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem;">
                    {% for dim, value in session.json_report.dimensions.items %}
                    <div>
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span style="text-transform: capitalize;">{{ dim }}</span>
                            <span>{{ value|floatformat:1 }}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ value }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quality Details Tab -->
<div id="details" class="tab-content animate-fade">
    <div class="card">
        <h3>Technical Audit Log</h3>
        <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;">
            <div style="padding: 1rem; border-left: 4px solid var(--danger); background: #fff1f2; border-radius: 4px;">
                <h4 style="margin: 0;">Validity Issues</h4>
                <p style="margin: 0.5rem 0 0; color: var(--text-muted);">{{ session.json_report.email_errors|length }}
                    records failed syntax or domain checks.</p>
            </div>
            <div style="padding: 1rem; border-left: 4px solid var(--warning); background: #fffbeb; border-radius: 4px;">
                <h4 style="margin: 0;">Duplication Matches</h4>
                <p style="margin: 0.5rem 0 0; color: var(--text-muted);">{{ session.json_report.duplicates }} identical
                    record pairs found in source.</p>
            </div>
            <div style="padding: 1rem; border-left: 4px solid var(--primary); background: #f0fdfa; border-radius: 4px;">
                <h4 style="margin: 0;">Structural Anomalies</h4>
                <p style="margin: 0.5rem 0 0; color: var(--text-muted);">{{ session.json_report.anomalies|length }}
                    instances of missing or corrupted data.</p>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Tab -->
<div id="analytics" class="tab-content animate-fade">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="card">
            <h3>Domain Distribution</h3>
            <div style="margin-top: 1.5rem;">
                {% for domain, count in session.json_report.distributions.domains.items %}
                <div
                    style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                    <span>{{ domain }}</span>
                    <strong style="color: var(--primary);">{{ count }}</strong>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card">
            <h3>Top Companies</h3>
            <div style="margin-top: 1.5rem;">
                {% for company, count in session.json_report.distributions.companies.items %}
                <div
                    style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                    <span>{{ company }}</span>
                    <strong style="color: var(--primary);">{{ count }}</strong>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Data Preview Tab -->
<div id="preview" class="tab-content animate-fade">
    <div class="card" style="overflow-x: auto; padding: 0;">
        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
            <thead style="background: var(--bg);">
                <tr>
                    {% for header in session.json_report.preview.headers %}
                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border);">{{ header }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in session.json_report.preview.rows %}
                <tr style="border-bottom: 1px solid var(--border);">
                    {% for cell in row %}
                    <td style="padding: 1rem; font-size: 0.875rem;">{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem; text-align: center;">Showing first 5 rows
        for validation preview.</p>
</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }
</script>
{% endblock %}